/*! feature-viewer 2015-10-22 */
function FeatureViewer(a,b,c){function d(a){document.addEventListener(y.FEATURE_SELECTED_EVENT,a)}function e(a){var b=[];return a.forEach(function(a){if(b===[])b.push(a.y),a.level=0;else{for(var c=!1,d=0;d<b.length;d++)if(a.x>b[d]){c=!0,a.level=d,b[d]=a.y;break}c===!1&&(b.push(a.y),a.level=b.length-1)}}),b.length}function f(a){v.append("g").attr("class","x axis Xaxis").attr("transform","translate(0,"+(a+20)+")").call(S)}function g(a){v.selectAll(".Xaxis").attr("transform","translate(0,"+(a+20)+")")}function h(a){u.attr("height",a+60+"px")}function i(){w=u.append("g").attr("class","pro axis").attr("transform","translate(0,"+I.top+")"),j()}function j(){x=w.selectAll(".yaxis").data(C).enter().append("g"),x.append("polygon").style("stroke","none").style("fill","rgba(95,46,38,0.2)").attr("points",function(a){return I.left-15+","+(a.y-3)+", "+(I.left-15)+","+(a.y+12)+", "+(I.left-7)+","+(a.y+4.5)}),x.append("rect").style("fill","rgba(95,46,38,0.2)").attr("x",function(){return I.left-95}).attr("y",function(a){return a.y-3}).attr("width","80").attr("height","15"),x.append("text").attr("class","yaxis").attr("text-anchor","start").attr("x",function(){return I.left-92}).attr("y",function(a){return a.y+8}).text(function(a){return a.title})}function k(a){a.on("mousedown",function(){brush_elm=u.select(".brush").node(),new_click_event=new Event("mousedown"),new_click_event.pageX=d3.event.pageX,new_click_event.clientX=d3.event.clientX,new_click_event.pageY=d3.event.pageY,new_click_event.clientY=d3.event.clientY,brush_elm.dispatchEvent(new_click_event)})}function l(){v.append("g").attr("class","brush").call(X).selectAll("rect").attr("height",D+50)}function m(){d3.select(b).selectAll("div.selectedRect").remove();var c=X.extent(),d=Math.abs(c[0]-c[1]);if(c[0]<c[1])var e=parseInt(c[0]-1),f=parseInt(c[1]+1);else var e=parseInt(c[1]+1),f=parseInt(c[0]-1);var g=O(d);if(!X.empty()&&d>H){var h=(a.length/d).toFixed(1);$(b+" .zoomUnit").text(h.toString()),A.showSequence&&g&&v.selectAll(".AA").empty()&&(F=e,V.sequence(a.substring(e,f),20,F)),L.domain(c),M.range(c),o(z,F),p(),d3.select(b).selectAll(".brush").call(X.clear())}else d3.select(b).selectAll(".brush").call(X.clear())}function n(){$(".zoomUnit").text("1"),L.domain([0,a.length-1]),M.range([0,a.length-1]);var b=O(a.length);b!==!1||v.selectAll(".AA").empty()||v.selectAll(".seqGroup").remove(),o(z,0),p()}function o(a,b){a.forEach(function(a){"rect"===a.type?W.rectangle(a):"multipleRect"===a.type?W.multiRec(a):"unique"===a.type?W.unique(a):"path"===a.type?W.path(a):"text"===a.type&&W.text(a,b)})}function p(){v.transition().duration(500).select(".x.axis").call(S)}function q(){var a=d3.select(".chart").append("div").attr("class","Vline").style("position","absolute").style("z-index","19").style("width","1px").style("height",D+50+"px").style("top","30px").style("background","#000");d3.select(".chart").on("mousemove.Vline",function(){mousex=d3.mouse(this)[0]-2,a.style("left",mousex+"px")})}function r(a){var b,c,d,e,f=d3.select(a).data(),g=d3.select(".background").attr("width");d3.select("body").selectAll("div.selectedRect").remove();var h=d3.select(".chart").append("div").attr("class","selectedRect");3===f[0].length?(b=f[0][0].x,c=f[0][1].x):f[0].x===f[0].y?(b=f[0].x-.5,c=f[0].y+.5):(b=f[0].x,c=f[0].y),L(b)<0?(d=I.left,e=L(c)):L(c)>g?(d=L(b)+I.left,e=g-L(b)):(d=L(b)+I.left,e=L(c)-L(b)),h.style({left:d+"px",top:"60px","background-color":"rgba(0, 0, 0, 0.2)",width:e+"px",height:D+50+"px",position:"absolute","z-index":-1,"box-shadow":"0 1px 2px 0 #656565"})}function s(b,c){if("undefined"==typeof c)var c={showAxis:!1,showSequence:!1,brushActive:!1,verticalLine:!1,toolbar:!1,bubbleHelp:!1,zoomMax:50};if($.fn.popover||(c.bubbleHelp=!1,console.warn("The bubble help requires tooltip and popover bootrstrap js libraries. The feature viewer will continue to work, but without the info bubble")),c.zoomMax&&(H=c.zoomMax),c.toolbar===!0){var d=$(b+" .svgHeader").length?d3.select(b+" .svgHeader"):d3.select(b).append("div").attr("class","svgHeader");if(!$(b+" .header-zoom").length){var e=d.append("div").attr("class","panel panel-default header-zoom").style("display","inline-block").style("width","150px").style("margin","20px 0px 0px").style("padding","0px");e.append("div").attr("class","panel-heading").style("padding","0px 15px").style("border-right","1px solid #DDD").style("display","inline-block").style("width","80px").append("h5").style("padding","0px").style("height","10px").style("color","#777").text("ZOOM"),e.append("div").attr("class","panel-body").style("display","inline-block").style("padding","0px").append("h5").style("padding-left","15px").style("height","10px").text("x ").append("span").attr("class","zoomUnit").text("1")}if(!$(b+" .header-position").length){var g=d.append("div").attr("class","panel panel-default header-position").style("display","inline-block").style("width","175px").style("margin","20px 20px 0px").style("padding","0px");g.append("div").attr("class","panel-heading").style("padding","0px 15px").style("border-right","1px solid #DDD").style("display","inline-block").append("h5").style("padding","0px").style("height","10px").style("color","#777").text("POSITION"),g.append("div").attr("class","panel-body").style("display","inline-block").style("padding","0px").append("h5").style("padding-left","15px").style("height","10px").append("span").attr("id","zoomPosition").text("0")}if(c.bubbleHelp===!0&&!$(b+" .header-help").length){var j="<div><strong>To zoom in :</strong> Left click to select area of interest</div><div><strong>To zoom out :</strong> Right click to reset the scale</div><div><strong>Zoom max  :</strong> Defined at <strong>"+H.toString()+"</strong></div>",k=d.append("div").attr("class","pull-right").style("display","inline-block").style("margin","25px 35px 0px 0px").style("padding","0px"),m=k.append("a").attr("type","button").attr("class","header-help").attr("data-toggle","popover").attr("data-placement","left").attr("title","Help").attr("data-content",j).style("font-size","1.5em");m.append("span").attr("class","glyphicon glyphicon-info-sign").attr("aria-hidden","true"),$(function(){$('[data-toggle="popover"]').popover({html:!0})})}}u=d3.select(b).append("svg").attr("width",J+I.left+I.right).attr("height",K+I.top+I.bottom).style("z-index","2").on("contextmenu",function(a,b){d3.event.preventDefault(),n()}),v=u.append("g").attr("transform","translate("+I.left+","+I.top+")"),v.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",J).attr("height",K),v.on("mousemove",function(){var a=d3.mouse(d3.select(".background").node());$(b+" #zoomPosition").text(Math.round(M(a[0])))}),c.showSequence&&(A.showSequence=!0,O(a.length)&&V.sequence(a,D),z.push({data:a,name:"Sequence",className:"AA",color:"black",type:"text"}),C.push({title:"Sequence",y:D-8})),c.showAxis&&f(D),i(),c.brushActive&&(A.brushActive=!0,G=!0,l()),c.verticalLine&&(A.verticalLine=!0,q()),h(D)}function t(a){D+=20,z.push(a),V.typeIdentifier(a),j(),g(D),h(D),A.brushActive&&v.selectAll(".brush rect").attr("height",D+50),A.verticalLine&&d3.selectAll(".Vline").style("height",D+50+"px")}var u,v,w,x,y={FEATURE_SELECTED_EVENT:"feature-viewer-position-selected"},b=b,a=a,z=[],A={showSequence:!1,brushActive:!1,verticalLine:!1},B=0,C=[],D=20,E=0,F=0,G=!1,H=50;d3.select(b).style("position","relative").style("padding","0px").style("z-index","2");var I={top:10,right:20,bottom:20,left:100},J=$(b).width()-I.left-I.right-17,K=600-I.top-I.bottom,L=d3.scale.linear().domain([0,a.length-1]).range([0,J]),M=d3.scale.linear().domain([0,J]).range([0,a.length-1]);d3.helper={},d3.helper.tooltip=function(a){function c(c){c.on("mouseover.tooltip",function(c,e){d3.select("body").selectAll("div.tooltip").remove();var g=d3.mouse(f),h=g[0]>J;if(h?d=d3.select(b).append("div").attr("class","tooltip3"):(d=d3.select(b).append("div").attr("class","tooltip2"),d.style({left:g[0]-15+"px"})),d.style({top:g[1]-55+"px","background-color":"rgba(0, 0, 0, 0.8)",width:"auto","max-width":"170px",height:"auto","max-height":"43px",padding:"5px",font:"10px sans-serif","text-align":"center",position:"absolute","z-index":45,"box-shadow":"0 1px 2px 0 #656565"}),"path"===a.type)var i='<p style="margin:2px;color:white">start : <span style="color:orangered">'+c[0].x+"</span></p>",j='<p style="margin:2px;color:white">end : <span style="color:orangered">'+c[1].x+"</span></p>";else if("unique"===a.type){var i='<p style="margin:2px;color:orangered">'+c.x+"</p>";if(c.description)var j='<p style="margin:2px;color:white;font-size:9px">'+c.description+"</p>";else var j=""}else{var i='<p style="margin:2px;color:orangered">'+c.x+" - "+c.y+"</p>";if(c.description)var j='<p style="margin:2px;color:white;font-size:9px">'+c.description+"</p>";else var j=""}d.html(i+j),h&&d.style({left:g[0]+10-d.node().getBoundingClientRect().width+"px"})}).on("mousemove.tooltip",function(a,b){var c=d3.mouse(f),e=c[0]>J;e?(d.attr("class","tooltip3"),d.style({left:c[0]+10-d.node().getBoundingClientRect().width+"px",top:c[1]-55+"px"})):(d.attr("class","tooltip2"),d.style({left:c[0]-15+"px",top:c[1]-55+"px"}))}).on("mouseout.tooltip",function(a,b){d.remove()}).on("click",function(c,d){var f,g,h,i,j=d3.select(".background").attr("width");if(d3.select("body").selectAll("div.selectedRect").remove(),e=d3.select(b).append("div").attr("class","selectedRect"),"path"===a.type?(f=c[0].x,g=c[1].x):"unique"===a.type?(f=c.x-.5,g=c.y+.5):(f=c.x,g=c.y),L(f)<0&&L(g)>j?(h=I.left,i=j):L(f)<0?(h=I.left,i=L(g)):L(g)>j?(h=L(f)+I.left,i=j-L(f)):(h=L(f)+I.left,i=L(g)-L(f)),e.style({left:h+"px",top:$(b+" .svgHeader").length?"60px":"10px","background-color":"rgba(0, 0, 0, 0.2)",width:i+"px",height:D+50+"px",position:"absolute","z-index":-1,"box-shadow":"0 1px 2px 0 #656565"}),CustomEvent){var k=new CustomEvent(y.FEATURE_SELECTED_EVENT,{detail:{start:c.x,end:c.y}});document.dispatchEvent(k)}else console.warn("CustomEvent is not defined....")})}var d,e,f=d3.select(b).node();return c.attr=function(a){return arguments.length?(attrs=a,this):attrs},c.style=function(a){return arguments.length?(styles=a,this):styles},c};var N=function(a){return L(a.x)},O=function(a){return J/a>5},P=function(a){return L(a.y)-L(a.x)},Q=d3.svg.line().interpolate("step-before").x(function(a){return L(a.x)}).y(function(a){return 10*-a.y+B}),R=d3.svg.line().interpolate("linear").x(function(a){return L(a.x)}).y(function(a){return a.y+6}),S=d3.svg.axis().scale(L).tickFormat(d3.format("d")).orient("bottom"),T=d3.scale.ordinal().domain([0,C.length]).rangeRoundBands([0,500],.1),U=(d3.svg.axis().scale(T).tickValues(C).tickFormat(function(a){return a}).orient("left"),{path:function(a){a.data.sort(function(a,b){return a.x-b.x});var b=e(a.data);a.data=a.data.map(function(a){return[{x:a.x,y:0,id:a.id},{x:a.y,y:a.level+1,id:a.id},{x:a.y,y:0,id:a.id}]}),B=10*b+5,a.height=10*b+5},multipleRect:function(a){a.data.sort(function(a,b){return a.x-b.x}),E=e(a.data),B=10*E+5}}),V={typeIdentifier:function(b){"rect"===b.type?(U.multipleRect(b),V.rectangle(b,a,D,E),C.push({title:b.name,y:D}),D+=20*(E-1)):"text"===b.type?(V.sequence(b.data,D),C.push({title:b.name,y:D})):"unique"===b.type?(V.unique(b,a,D),C.push({title:b.name,y:D})):"multipleRect"===b.type?(U.multipleRect(b),V.multipleRect(b,a,D,E),C.push({title:b.name,y:D}),D+=10*(E-1)):"path"===b.type&&(U.path(b),V.path(b,a,D),D+=B,C.push({title:b.name,y:D-10}))},sequence:function(a,b,c){if(!c)var c=0;v.append("g").attr("class","seqGroup").selectAll(".AA").data(a).enter().append("text").attr("clip-path","url(#clip)").attr("class","AA").attr("text-anchor","left").attr("x",function(a,b){return L.range([0,J-5])(b+c)}).attr("y",b).attr("font-size","10px").attr("font-family","monospace").text(function(a,b){return a})},rectangle:function(a,b,c){for(var d=20,e=v.append("g").attr("class","rectangle").attr("clip-path","url(#clip)").attr("transform","translate(0,"+c+")"),f=0;E>f;f++)e.append("path").attr("d",R([{x:0,y:f*d},{x:b.length-1,y:f*d}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px");var g=e.selectAll("."+a.className+"Group").data(a.data).enter().append("g").attr("class",a.className+"Group").attr("transform",function(a){return"translate("+L(a.x)+",0)"});g.append("rect").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("y",function(a){return a.level*d}).attr("width",P).attr("height",12).style("fill",a.color).style("z-index","13").call(d3.helper.tooltip(a)),g.append("text").attr("class","element "+a.className+"Text").attr("y",function(a){return a.level*d+6}).attr("dy","0.35em").style("font-size","10px").text(function(a){return a.description}).style("fill","black").style("z-index","15").style("visibility",function(a){return a.description&&L(a.y)-L(a.x)>8*a.description.length?"visible":"hidden"}).call(d3.helper.tooltip(a)),k(g)},unique:function(a,b,c){var d=v.append("g").attr("class","uniquePosition").attr("transform","translate(0,"+c+")");d.append("path").attr("d",R([{x:0,y:0},{x:b.length-1,y:0}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px"),d.selectAll("."+a.className).data(a.data).enter().append("rect").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("x",function(a){return L(a.x-.5)}).attr("width",function(a){return L(1)<2?2:L(1)}).attr("height",12).style("fill",a.color).style("z-index","3").call(d3.helper.tooltip(a)),k(d)},path:function(a,b,c){var d=v.append("g").attr("class","pathing").attr("transform","translate(0,"+c+")");d.append("path").attr("d",Q([{x:0,y:0},{x:b.length-1,y:0}])).style("z-index","0").style("stroke",a.color).style("stroke-width","1px"),d.selectAll("."+a.className).data(a.data).enter().append("path").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a[0].id}).attr("d",Q).style("fill","none").style("stroke",a.color).style("z-index","3").style("stroke-width","2px").call(d3.helper.tooltip(a)),k(d)},multipleRect:function(a,b,c,d){for(var e=8,f=10,g=v.append("g").attr("class","multipleRects").attr("transform","translate(0,"+c+")"),h=0;d>h;h++)g.append("path").attr("d",R([{x:0,y:h*f-2},{x:b.length-1,y:h*f-2}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px");g.selectAll("."+a.className).data(a.data).enter().append("rect").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("x",N).attr("y",function(a){return a.level*f}).attr("width",P).attr("height",e).style("fill",a.color).style("z-index","13").call(d3.helper.tooltip(a)),k(g)}},W={rectangle:function(a){v.selectAll("."+a.className+"Group").data(a.data).attr("transform",function(a){return"translate("+L(a.x)+",0)"}),v.selectAll("."+a.className).attr("width",function(a){return L(a.y)-L(a.x)}),v.selectAll("."+a.className+"Text").style("visibility",function(a){return a.description&&L(a.y)-L(a.x)>8*a.description.length?"visible":"hidden"})},multiRec:function(a){v.selectAll("."+a.className).data(a.data).attr("x",function(a){return L(a.x)}).attr("width",function(a){return L(a.y)-L(a.x)})},unique:function(a){v.selectAll("."+a.className).data(a.data).attr("x",function(a){return L(a.x-.5)}).attr("width",function(a){return L(a.x+.5)-L(a.x-.5)<2?2:L(a.x+.5)-L(a.x-.5)})},path:function(a){v.selectAll("."+a.className).data(a.data).attr("d",Q.y(function(b){return 10*-b.y+a.height}))},text:function(a,b){v.selectAll("."+a.className).data(a.data).attr("x",function(a,c){return L(c+b)})}},X=d3.svg.brush().x(L).on("brushend",m);return s(b,c),{onFeatureSelected:d,create:s,addFeature:t,selection:r,events:y}}