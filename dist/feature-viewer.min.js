/*! testD3 2015-06-02 */
function FeatureViewer(a,b,c){function d(a){var b=[];return a.forEach(function(a){if(b===[])b.push(a.y),a.level=0;else{for(var c=!1,d=0;d<b.length;d++)if(a.x>b[d]){c=!0,a.level=d,b[d]=a.y;break}c===!1&&(b.push(a.y),a.level=b.length-1)}}),b.length}function e(a){t.append("g").attr("class","x axis Xaxis").attr("transform","translate(0,"+(a+20)+")").call(M)}function f(a){t.selectAll(".Xaxis").attr("transform","translate(0,"+(a+20)+")")}function g(){u=s.append("g").attr("class","pro axis").attr("transform","translate(0,"+C.top+")"),u.selectAll(".yaxis").data(y).enter().append("text").attr("class","yaxis").attr("text-anchor","end").attr("x",function(){return C.left-10}).attr("y",function(a){return a.y+8}).text(function(a){return a.title})}function h(){u.selectAll(".yaxis").data(y).enter().append("text").attr("class","yaxis").attr("text-anchor","end").attr("x",function(){return C.left-10}).attr("y",function(a){return a.y+8}).text(function(a){return a.title})}function i(a){a.on("mousedown",function(){brush_elm=s.select(".brush").node(),new_click_event=new Event("mousedown"),new_click_event.pageX=d3.event.pageX,new_click_event.clientX=d3.event.clientX,new_click_event.pageY=d3.event.pageY,new_click_event.clientY=d3.event.clientY,brush_elm.dispatchEvent(new_click_event)})}function j(){t.append("g").attr("class","brush").call(R).selectAll("rect").attr("height",z+50)}function k(){d3.select("body").selectAll("div.selectedRect").remove();var b=R.extent(),c=Math.abs(b[0]-b[1]);if(b[0]<b[1])var d=parseInt(b[0]-1),e=parseInt(b[1]+1);else var d=parseInt(b[1]+1),e=parseInt(b[0]-1);var f=H(c);!R.empty()&&c>5?(w.showSequence&&f&&t.selectAll(".AA").empty()&&(B=d,P.sequence(a.substring(d,e),20,B)),F.domain(b),m(v,B),n(),d3.select(".brush").call(R.clear())):d3.select(".brush").call(R.clear())}function l(){F.domain([0,a.length-1]);var b=H(a.length);b!==!1||t.selectAll(".AA").empty()||t.selectAll(".seqGroup").remove(),m(v,0),n()}function m(a,b){a.forEach(function(a){"rect"===a.type||"multipleRect"===a.type?Q.rectangle(a):"unique"===a.type?Q.unique(a):"path"===a.type?Q.path(a):"text"===a.type&&Q.text(a,b)})}function n(){t.transition().duration(500).select(".x.axis").call(M)}function o(){var a=d3.select(".chart").append("div").attr("class","Vline").style("position","absolute").style("z-index","19").style("width","1px").style("height",z+50+"px").style("top","30px").style("background","#000");d3.select(".chart").on("mousemove.Vline",function(){mousex=d3.mouse(this)[0]-2,a.style("left",mousex+"px")})}function p(a){var b,c,d,e,f=d3.select(a).data(),g=d3.select(".background").attr("width");d3.select("body").selectAll("div.selectedRect").remove();var h=d3.select(".chart").append("div").attr("class","selectedRect");3===f[0].length?(b=f[0][0].x,c=f[0][1].x,console.log("aaaaaaaa")):f[0].x===f[0].y?(b=f[0].x-1,c=f[0].y+1,console.log("bbbbbbbb")):(b=f[0].x,c=f[0].y,console.log("ccccccc")),F(b)<0?(d=C.left,e=F(c)):F(c)>g?(d=F(b)+C.left,e=g-F(b)):(d=F(b)+C.left,e=F(c)-F(b)),h.style({left:d+"px",top:"20px","background-color":"rgba(0, 0, 0, 0.3)",width:e+"px",height:z+50+"px",position:"absolute","z-index":1,"box-shadow":"0 1px 2px 0 #656565"})}function q(b,c){if("undefined"==typeof c)var c={showAxis:!1,showSequence:!1,brushActive:!1,verticalLine:!1};s=d3.select(b).append("svg").attr("width",D+C.left+C.right).attr("height",E+C.top+C.bottom).on("contextmenu",function(a,b){d3.event.preventDefault(),l()}),t=s.append("g").attr("transform","translate("+C.left+","+C.top+")"),t.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",D).attr("height",E),c.showSequence&&(w.showSequence=!0,H(a.length)&&P.sequence(a,z),v.push({data:a,name:"Sequence",className:"AA",color:"black",type:"text"}),y.push({title:"sequence",y:z-8})),c.showAxis&&e(z),g(),c.brushActive&&(w.brushActive=!0,j()),c.verticalLine&&(w.verticalLine=!0,o())}function r(a){z+=20,v.push(a),P.typeIdentifier(a),h(),f(z),w.brushActive&&t.selectAll(".brush rect").attr("height",z+50),w.verticalLine&&d3.selectAll(".Vline").style("height",z+50+"px")}var s,t,u,b=b,a=a,v=[],w={showSequence:!1,brushActive:!1,verticalLine:!1},x=0,y=[],z=20,A=0,B=0;d3.helper={},d3.helper.tooltip=function(a){function b(b){b.on("mouseover.tooltip",function(b,d){d3.select("body").selectAll("div.tooltip").remove(),c=d3.select("body").append("div").attr("class","tooltip2");var f=d3.mouse(e);if(c.style({left:f[0]-30+"px",top:f[1]-52+"px","background-color":"rgba(0, 0, 0, 0.8)",width:"auto","max-width":"170px",height:"auto","max-height":"43px",padding:"5px",font:"10px sans-serif","text-align":"center",position:"absolute","z-index":1001,"box-shadow":"0 1px 2px 0 #656565"}),"path"===a.type)var g='<p style="margin:2px;color:white">start : <span style="color:orangered">'+b[0].x+"</span></p>",h='<p style="margin:2px;color:white">end : <span style="color:orangered">'+b[1].x+"</span></p>";else if("unique"===a.type){var g='<p style="margin:2px;color:orangered">'+b.x+"</p>";if(b.description)var h='<p style="margin:2px;color:white;font-size:9px">'+b.description+"</p>";else var h=""}else{var g='<p style="margin:2px;color:orangered">'+b.x+" - "+b.y+"</p>";if(b.description)var h='<p style="margin:2px;color:white;font-size:9px">'+b.description+"</p>";else var h=""}c.html(g+h)}).on("mousemove.tooltip",function(a,b){var d=d3.mouse(e);c.style({left:d[0]-30+"px",top:d[1]-52+"px"})}).on("mouseout.tooltip",function(a,b){c.remove()}).on("click",function(b,c){var e,f,g,h,i=d3.select(".background").attr("width");d3.select("body").selectAll("div.selectedRect").remove(),d=d3.select(".chart").append("div").attr("class","selectedRect"),"path"===a.type?(e=b[0].x,f=b[1].x):"unique"===a.type?(e=b.x-1,f=b.y+1):(e=b.x,f=b.y),F(e)<0?(g=C.left,h=F(f)):F(f)>i?(g=F(e)+C.left,h=i-F(e)):(g=F(e)+C.left,h=F(f)-F(e)),d.style({left:g+"px",top:"20px","background-color":"rgba(0, 0, 0, 0.3)",width:h+"px",height:z+50+"px",position:"absolute","z-index":1,"box-shadow":"0 1px 2px 0 #656565"})})}var c,d,e=d3.select("body").node();return b.attr=function(a){return arguments.length?(attrs=a,this):attrs},b.style=function(a){return arguments.length?(styles=a,this):styles},b};var C={top:20,right:20,bottom:60,left:100},D=$(b).width()-C.left-C.right-17,E=500-C.top-C.bottom,F=d3.scale.linear().domain([0,a.length-1]).range([0,D]),G=function(a){return F(a.x)},H=function(a){return D/a>5},I=function(a){return F(a.y)-F(a.x)},J=function(a){return F(1)},K=d3.svg.line().interpolate("step-before").x(function(a){return F(a.x)}).y(function(a){return 10*-a.y+x}),L=d3.svg.line().interpolate("linear").x(function(a){return F(a.x)}).y(function(a){return a.y+6}),M=d3.svg.axis().scale(F).tickFormat(d3.format("d")).orient("bottom"),N=d3.scale.ordinal().domain([0,y.length]).rangeRoundBands([0,500],.1),O=(d3.svg.axis().scale(N).tickValues(y).tickFormat(function(a){return a}).orient("left"),{path:function(a){a.data.sort(function(a,b){return a.x-b.x});var b=d(a.data);a.data=a.data.map(function(a){return[{x:a.x,y:0,id:a.id},{x:a.y,y:a.level+1,id:a.id},{x:a.y,y:0,id:a.id}]}),x=10*b+5,a.height=10*b+5},multipleRect:function(a){a.data.sort(function(a,b){return a.x-b.x}),A=d(a.data),x=10*A+5}}),P={typeIdentifier:function(b){"rect"===b.type?(P.rectangle(b,a,z),y.push({title:b.name,y:z})):"text"===b.type?(P.sequence(b.data,z),y.push({title:b.name,y:z})):"unique"===b.type?(P.unique(b,a,z),y.push({title:b.name,y:z})):"multipleRect"===b.type?(O.multipleRect(b),P.multipleRect(b,a,z,A),y.push({title:b.name,y:z}),z+=x):"path"===b.type&&(O.path(b),P.path(b,a,z),z+=x,y.push({title:b.name,y:z-10}))},sequence:function(a,b,c){if(!c)var c=0;t.append("g").attr("class","seqGroup").selectAll(".AA").data(a).enter().append("text").attr("clip-path","url(#clip)").attr("class","AA").attr("text-anchor","left").attr("x",function(a,b){return F.range([0,D-5])(b+c)}).attr("y",b).attr("font-size","10px").attr("font-family","monospace").text(function(a,b){return a})},rectangle:function(a,b,c){var d=t.append("g").attr("class","rectangle").attr("transform","translate(0,"+c+")");d.append("path").attr("d",L([{x:0,y:0},{x:b.length-1,y:0}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px"),d.selectAll("."+a.className).data(a.data).enter().append("rect").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("x",G).attr("width",I).attr("height",12).style("fill",a.color).style("z-index","13").call(d3.helper.tooltip(a)),i(d)},unique:function(a,b,c){var d=t.append("g").attr("class","uniquePosition").attr("transform","translate(0,"+c+")");d.append("path").attr("d",L([{x:0,y:0},{x:b.length-1,y:0}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px"),d.selectAll("."+a.className).data(a.data).enter().append("rect").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("x",G).attr("width",J).attr("height",12).style("fill",a.color).style("z-index","3").call(d3.helper.tooltip(a)),i(d)},path:function(a,b,c){var d=t.append("g").attr("class","pathing").attr("transform","translate(0,"+c+")");d.append("path").attr("d",K([{x:0,y:0},{x:b.length-1,y:0}])).style("z-index","0").style("stroke",a.color).style("stroke-width","1px"),console.log(a),d.selectAll("."+a.className).data(a.data).enter().append("path").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a[0].id}).attr("d",K).style("fill","none").style("stroke",a.color).style("z-index","3").style("stroke-width","2px").call(d3.helper.tooltip(a)),i(d)},multipleRect:function(a,b,c,d){for(var e=t.append("g").attr("class","multipleRects").attr("transform","translate(0,"+c+")"),f=0;d>f;f++)e.append("path").attr("d",L([{x:0,y:10*f-2},{x:b.length-1,y:10*f-2}])).attr("class",function(){return"line"+a.className}).style("z-index","0").style("stroke",a.color).style("stroke-width","1px");e.selectAll("."+a.className).data(a.data).enter().append("rect").attr("clip-path","url(#clip)").attr("class","element "+a.className).attr("id",function(a){return"f"+a.id}).attr("x",G).attr("y",function(a){return 10*a.level}).attr("width",I).attr("height",8).style("fill",a.color).style("z-index","3").call(d3.helper.tooltip(a)),i(e)}},Q={rectangle:function(a){t.selectAll("."+a.className).data(a.data).attr("x",function(a){return F(a.x)}).attr("width",function(a){return F(a.y)-F(a.x)})},unique:function(a){t.selectAll("."+a.className).data(a.data).attr("x",function(a){return F(a.x-.5)}).attr("width",function(a){return F(a.x+.5)-F(a.x-.5)})},path:function(a){t.selectAll("."+a.className).data(a.data).attr("d",K.y(function(b){return 10*-b.y+a.height}))},text:function(a,b){t.selectAll("."+a.className).data(a.data).attr("x",function(a,c){return F(c+b)})}},R=d3.svg.brush().x(F).on("brushend",k);return q(b,c),{create:q,addFeature:r,selection:p}}